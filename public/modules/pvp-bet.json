{
  "name": "PvPBet",
  "author": "Mad",
  "supportedGames": ["7 days to die"],
  "versions": [
    {
      "tag": "latest",
      "description": "Allows players to bet currency on PvP battles. Players can challenge each other and the winner takes the pot. Must have PrismaCore. ",
      "configSchema": "{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"required\":[\"xLocation\",\"zLocation\",\"minimumBetAmount\"],\"properties\":{\"minimumBetAmount\":{\"title\":\"minimumBetAmount\",\"description\":\"Minimum currency amount required to create a PvP bet\",\"default\":100,\"type\":\"number\",\"minimum\":1},\"xLocation\":{\"title\":\"xLocation\",\"description\":\"X coordinate for PvP arena center\",\"default\":0,\"type\":\"number\"},\"zLocation\":{\"title\":\"zLocation\",\"description\":\"Z coordinate for PvP arena center\",\"default\":0,\"type\":\"number\"},\"discordChannelId\":{\"title\":\"discordChannelId\",\"description\":\"Discord channel ID for posting leaderboard (optional)\",\"default\":\"\",\"type\":\"string\"}}}",
      "uiSchema": "{}",
      "commands": [
        {
          "function": "import { data, takaro, TakaroUserError } from '@takaro/helpers';\n\nasync function main() {\n    const { gameServerId, player, module, pog } = data;\n    const { amount } = data.arguments;\n\n    if (amount <= 0) {\n        throw new TakaroUserError('Bet amount must be greater than 0.');\n    }\n\n    // Get minimum bet amount from config\n    const minimumBetAmount = module.userConfig.minimumBetAmount || 100;\n\n    if (amount < minimumBetAmount) {\n        await pog.pm(`Bet amount must be at least ${minimumBetAmount}.`);\n        return;\n    }\n\n    // Get player's current currency and gameId\n    const pogRes = await takaro.playerOnGameserver.playerOnGameServerControllerGetOne(gameServerId, player.id);\n    const currentCurrency = pogRes.data.data.currency;\n    const playerGameId = pogRes.data.data.gameId;\n\n    if (currentCurrency < amount) {\n        throw new TakaroUserError(`You don't have enough currency. You have ${currentCurrency} but need ${amount}.`);\n    }\n\n    // Check if player already has a pending bet\n    const existingBetRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            key: [`pvpbet_pending_${player.id}`],\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        }\n    });\n\n    if (existingBetRes.data.data.length > 0) {\n        throw new TakaroUserError('You already have a pending bet. Wait for it to be accepted or expire before creating a new one.');\n    }\n\n    // Check if there's already an active match\n    const activeMatchRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            key: ['pvpbet_active'],\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        }\n    });\n\n    if (activeMatchRes.data.data.length > 0) {\n        throw new TakaroUserError('There is already an active PvP bet match. Please wait for it to complete.');\n    }\n\n    // Create pending bet variable (expires in 30 minutes)\n    const expiryDate = new Date();\n    expiryDate.setMinutes(expiryDate.getMinutes() + 30);\n\n    await takaro.variable.variableControllerCreate({\n        key: `pvpbet_pending_${player.id}`,\n        value: JSON.stringify({\n            amount,\n            playerId: player.id,\n            playerName: player.name,\n            gameId: playerGameId,\n            epicOnlineServicesId: player.epicOnlineServicesId\n        }),\n        moduleId: module.moduleId,\n        gameServerId,\n        expiresAt: expiryDate.toISOString()\n    });\n\n    // Get currency name\n    const settingsRes = await takaro.settings.settingsControllerGetOne('currencyName');\n    const currencyName = settingsRes.data.data.value || 'currency';\n\n    // Announce the bet\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: `[E902FE]${player.name}[-] wants to PvP for [FFD700]${amount} ${currencyName}[-]! Type [5DE2E7]/pvpAccept[-] to accept the challenge.`\n    });\n}\n\nawait main();",
          "name": "pvpbet",
          "description": null,
          "trigger": "pvpbet",
          "helpText": "Challenge another player to a PvP battle with a currency bet. Usage: /pvpbet [amount]",
          "arguments": [
            {
              "name": "amount",
              "type": "number",

              "helpText": "Amount of currency to bet",
              "position": 0
            }
          ]
        },
        {
          "function": "import { data, takaro, TakaroUserError } from '@takaro/helpers';\n\nasync function main() {\n    const { gameServerId, player, module } = data;\n\n    // Find any pending bet\n    const pendingBetsRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        },\n        search: {\n            key: ['pvpbet_pending_']\n        }\n    });\n\n    if (pendingBetsRes.data.data.length === 0) {\n        throw new TakaroUserError('No active PvP bet to accept.');\n    }\n\n    // Get the first pending bet\n    const pendingBet = pendingBetsRes.data.data[0];\n    const betData = JSON.parse(pendingBet.value);\n\n    // Check if player is trying to accept their own bet\n    if (betData.playerId === player.id) {\n        throw new TakaroUserError('You cannot accept your own bet!');\n    }\n\n    // Check if there's already an active match\n    const activeMatchRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            key: ['pvpbet_active'],\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        }\n    });\n\n    if (activeMatchRes.data.data.length > 0) {\n        throw new TakaroUserError('There is already an active PvP bet match. Please wait for it to complete.');\n    }\n\n    // Get accepting player's current currency and gameId\n    const pogRes = await takaro.playerOnGameserver.playerOnGameServerControllerGetOne(gameServerId, player.id);\n    const currentCurrency = pogRes.data.data.currency;\n    const player2GameId = pogRes.data.data.gameId;\n\n    if (currentCurrency < betData.amount) {\n        throw new TakaroUserError(`You don't have enough currency. You have ${currentCurrency} but need ${betData.amount}.`);\n    }\n\n    // Deduct currency from both players\n    await Promise.all([\n        takaro.playerOnGameserver.playerOnGameServerControllerDeductCurrency(gameServerId, betData.playerId, {\n            currency: betData.amount\n        }),\n        takaro.playerOnGameserver.playerOnGameServerControllerDeductCurrency(gameServerId, player.id, {\n            currency: betData.amount\n        })\n    ]);\n\n    // Delete the pending bet\n    await takaro.variable.variableControllerDelete(pendingBet.id);\n\n    // Create active match variable with 20-minute expiration\n    const expiryDate = new Date();\n    expiryDate.setMinutes(expiryDate.getMinutes() + 20);\n\n    await takaro.variable.variableControllerCreate({\n        key: 'pvpbet_active',\n        value: JSON.stringify({\n            player1: {\n                id: betData.playerId,\n                name: betData.playerName,\n                gameId: betData.gameId,\n                epicOnlineServicesId: betData.epicOnlineServicesId\n            },\n            player2: {\n                id: player.id,\n                name: player.name,\n                gameId: player2GameId,\n                epicOnlineServicesId: player.epicOnlineServicesId\n            },\n            amount: betData.amount,\n            totalPot: betData.amount * 2,\n            startTime: new Date().toISOString()\n        }),\n        moduleId: module.moduleId,\n        gameServerId,\n        expiresAt: expiryDate.toISOString()\n    });\n\n    // Get user config from module\n    const { xLocation, zLocation } = module.userConfig;\n\n    // Teleport both players to opposite sides\n    // Betting player: x - 30, z + 30\n    const player1X = xLocation - 30;\n    const player1Z = zLocation + 30;\n    \n    // Accepting player: x + 30, z - 30\n    const player2X = xLocation + 30;\n    const player2Z = zLocation - 30;\n\n    await Promise.all([\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `teleportplayer \"${betData.playerName}\" ${player1X} -1 ${player1Z}`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `teleportplayer \"${player.name}\" ${player2X} -1 ${player2Z}`\n        })\n    ]);\n\n    // Set both players to PvP mode\n    await Promise.all([\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `buffplayer \"${betData.playerName}\" noticePlayerVsPlayer`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `buffplayer \"${player.name}\" noticePlayerVsPlayer`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `EOC ${betData.playerName} \"setgamestat PlayerKillingMode 3\"`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `EOC ${player.name} \"setgamestat PlayerKillingMode 3\"`\n        })\n    ]);\n\n    // Get currency name\n    const settingsRes = await takaro.settings.settingsControllerGetOne('currencyName');\n    const currencyName = settingsRes.data.data.value || 'currency';\n\n    // Announce match start\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: `[FF6D6A]PvP bet accepted![-] [E902FE]${betData.playerName}[-] vs [5DE2E7]${player.name}[-] for [FFD700]${betData.amount * 2} ${currencyName}[-] total! May the best fighter win!`\n    });\n}\n\nawait main();",
          "name": "pvpaccept",
          "description": null,
          "trigger": "pvpaccept",
          "helpText": "Accept an active PvP bet challenge",
          "arguments": []
        }
      ],
      "hooks": [
        {
          "function": "import { data, takaro } from '@takaro/helpers';\n\nasync function main() {\n    const { gameServerId, eventData, module } = data;\n\n    // Check if there's an active bet\n    const activeMatchRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            key: ['pvpbet_active'],\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        }\n    });\n\n    if (activeMatchRes.data.data.length === 0) {\n        // No active bet, ignore\n        return;\n    }\n\n    const activeBet = activeMatchRes.data.data[0];\n    const betData = JSON.parse(activeBet.value);\n\n    // Parse the log line\n    const logMessage = eventData.msg || '';\n    \n    const regex = /playerKilledByPlayer:\\s+(\\w+)\\s+\\(offenderSteamId=Steam_(\\d+)\\).*killed\\s+(\\w+)\\s+\\(victimSteamId=Steam_(\\d+)\\)/;\n    const match = logMessage.match(regex);\n\n    if (!match) {\n        console.log('Could not parse kill log line:', logMessage);\n        return;\n    }\n\n    const killerName = match[1];\n    const victimName = match[3];\n\n    console.log(`Parsed kill: ${killerName} killed ${victimName}`);\n\n    // Check if this kill involves the two betting players\n    let winner = null;\n    let loser = null;\n\n    if (killerName === betData.player1.name && victimName === betData.player2.name) {\n        winner = betData.player1;\n        loser = betData.player2;\n    } else if (killerName === betData.player2.name && victimName === betData.player1.name) {\n        winner = betData.player2;\n        loser = betData.player1;\n    } else {\n        // Kill doesn't involve our betting players\n        console.log('Kill does not involve betting players');\n        return;\n    }\n\n    console.log(`Winner: ${winner.name}, Loser: ${loser.name}, Pot: ${betData.totalPot}`);\n\n    // Track win for leaderboard\n    const winKey = `pvpbet_wins_${winner.id}`;\n    const winSearchRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            key: [winKey],\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        }\n    });\n\n    if (winSearchRes.data.data.length > 0) {\n        // Update existing win count\n        const winVar = winSearchRes.data.data[0];\n        const winData = JSON.parse(winVar.value);\n        const currentWins = winData.wins;\n        await takaro.variable.variableControllerUpdate(winVar.id, {\n            value: JSON.stringify({\n                wins: currentWins + 1,\n                playerName: winner.name,\n                playerId: winner.id\n            })\n        });\n    } else {\n        // Create new win count\n        await takaro.variable.variableControllerCreate({\n            key: winKey,\n            value: JSON.stringify({\n                wins: 1,\n                playerName: winner.name,\n                playerId: winner.id\n            }),\n            moduleId: module.moduleId,\n            gameServerId\n        });\n    }\n\n    // Award the winner\n    await takaro.playerOnGameserver.playerOnGameServerControllerAddCurrency(gameServerId, winner.id, {\n        currency: betData.totalPot\n    });\n\n    // Delete the active bet\n    await takaro.variable.variableControllerDelete(activeBet.id);\n\n    // Get currency name\n    const settingsRes = await takaro.settings.settingsControllerGetOne('currencyName');\n    const currencyName = settingsRes.data.data.value || 'currency';\n\n    // Announce the winner with currency name\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: `[FE9402]PvP bet complete![-] [A1DA64]${winner.name}[-] has defeated [E4080A]${loser.name}[-] and won [FFD700]${betData.totalPot} ${currencyName}[-]!`\n    });\n\n    // Remove PvP buffs and reset PlayerKillingMode for both players\n    await Promise.all([\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `debuffplayer \"${winner.name}\" noticePlayerVsPlayer`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `debuffplayer \"${loser.name}\" noticePlayerVsPlayer`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `EOC ${winner.name} \"setgamestat PlayerKillingMode 0\"`\n        }),\n        takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n            command: `EOC ${loser.name} \"setgamestat PlayerKillingMode 0\"`\n        })\n    ]);\n}\n\nawait main();",
          "name": "PvP Bet Kill Tracker",
          "description": null,
          "eventType": "log",
          "regex": "playerKilledByPlayer"
        }
      ],
      "cronJobs": [
        {
          "function": "import { data, takaro } from '@takaro/helpers';\n\nasync function main() {\n    const { gameServerId, module } = data;\n\n    // Get discordChannelId from module userConfig\n    const discordChannelId = module.userConfig?.discordChannelId || '';\n\n    // Post explanation of PvP betting\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[FF6D6A]===== PvP BETTING ARENA =====[FFFFFF]'\n    });\n\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[FEF902]Want to bet on your PvP skills?[FFFFFF]'\n    });\n\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[5DE2E7]1. Use /pvpbet [amount] to challenge someone[FFFFFF]'\n    });\n\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[A1DA64]2. Others can /pvpAccept to enter the arena[FFFFFF]'\n    });\n\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[E902FE]3. Fight in the PvP zone - Winner takes ALL![FFFFFF]'\n    });\n\n    // Get all PvP bet wins from variables\n    const winsRes = await takaro.variable.variableControllerSearch({\n        filters: {\n            moduleId: [module.moduleId],\n            gameServerId: [gameServerId]\n        },\n        search: {\n            key: ['pvpbet_wins_']\n        }\n    });\n\n    if (winsRes.data.data.length === 0) {\n        await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n            message: '[CC6CE7]No PvP bet winners yet. Be the first![FFFFFF]'\n        });\n        return;\n    }\n\n    // Parse and sort wins\n    const leaderboard = winsRes.data.data.map(varData => {\n        const winData = JSON.parse(varData.value);\n        return {\n            playerName: winData.playerName,\n            wins: winData.wins,\n            playerId: winData.playerId\n        };\n    }).sort((a, b) => b.wins - a.wins).slice(0, 3);\n\n    // Post leaderboard header\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n        message: '[FE9402]===== TOP PVP CHAMPIONS =====[FFFFFF]'\n    });\n\n    // Post each winner in separate message\n    const colors = ['[FFD700]', '[C0C0C0]', '[CD7F32]']; // Gold, Silver, Bronze\n    const medals = ['1st', '2nd', '3rd'];\n\n    for (let i = 0; i < leaderboard.length; i++) {\n        const leader = leaderboard[i];\n        await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n            message: `${colors[i]}${medals[i]}: ${leader.playerName} - ${leader.wins} wins[FFFFFF]`\n        });\n    }\n\n    // Post to Discord if channel is configured\n    if (discordChannelId && discordChannelId.trim() !== '') {\n        try {\n            // Build Discord embed\n            const fields = leaderboard.map((leader, i) => ({\n                name: `${medals[i]} Place - ${leader.playerName}`,\n                value: `${leader.wins} wins`,\n                inline: false\n            }));\n\n            const embedData = {\n                title: 'PvP Betting Arena - Top Champions',\n                description: 'Challenge others with /pvpbet [amount] and prove your PvP skills! Winner takes all!',\n                color: 16744192, // Orange color\n                fields: fields,\n                timestamp: new Date().toISOString()\n            };\n\n            // Check if we have a stored Discord message ID\n            const msgIdRes = await takaro.variable.variableControllerSearch({\n                filters: {\n                    key: ['pvpbet_discord_leaderboard_msg'],\n                    moduleId: [module.moduleId],\n                    gameServerId: [gameServerId]\n                }\n            });\n\n            if (msgIdRes.data.data.length > 0) {\n                // Update existing message\n                const storedMessageId = msgIdRes.data.data[0].value;\n                await takaro.discord.discordControllerUpdateMessage(discordChannelId, storedMessageId, {\n                    embed: embedData\n                });\n                console.log('Updated existing Discord leaderboard message:', storedMessageId);\n            } else {\n                // Create new message and store its ID\n                const msgRes = await takaro.discord.discordControllerSendMessage(discordChannelId, {\n                    embed: embedData\n                });\n                \n                // Store the message ID for future updates\n                await takaro.variable.variableControllerCreate({\n                    key: 'pvpbet_discord_leaderboard_msg',\n                    value: msgRes.data.data.id,\n                    moduleId: module.moduleId,\n                    gameServerId\n                });\n                console.log('Posted new Discord leaderboard message:', msgRes.data.data.id);\n            }\n        } catch (error) {\n            console.log('Failed to post to Discord:', error);\n        }\n    }\n}\n\nawait main();",
          "name": "PvP Bet Announcement & Leaderboard",
          "description": null,
          "temporalValue": "22 */2 * * *"
        }
      ],
      "functions": [],
      "permissions": [
        {
          "canHaveCount": false,
          "description": "Allows players to create and accept PvP bets",
          "permission": "PVP_BET_USE",
          "friendlyName": "Use PvP Betting"
        }
      ]
    }
  ],
  "takaroVersion": "v0.4.10"
}
