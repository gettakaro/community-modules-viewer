{
  "name": "Leaderboards",
  "author": "Unknown",
  "supportedGames": ["7 Days to Die"],
  "versions": [
    {
      "tag": "latest",
      "description": "Tracks and displays leaderboards for zombie kills, player kills, level, and deaths. Updates hourly and posts to Discord.",
      "configSchema": "{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"type\":\"object\",\"properties\":{\"discordChannelId\":{\"type\":\"string\",\"title\":\"Discord Channel ID\",\"description\":\"The Discord channel ID where leaderboards will be posted (e.g., 1234567890)\",\"minLength\":17,\"maxLength\":20}},\"required\":[\"discordChannelId\"]}",
      "uiSchema": "{\"discordChannelId\":{\"ui:help\":\"Find this by right-clicking a Discord channel and selecting 'Copy Channel ID' (Developer Mode must be enabled)\"}}",
      "commands": [],
      "hooks": [],
      "cronJobs": [
        {
          "function": "import { data, takaro } from '@takaro/helpers';\n\nasync function main() {\n  const { gameServerId, module } = data;\n  \n  // Get user config for Discord channel\n  const moduleConfig = module.userConfig || {};\n  const discordChannelId = moduleConfig.discordChannelId;\n  \n  if (!discordChannelId) {\n    console.log('Discord channel ID not configured');\n    return;\n  }\n  \n  // Execute lp command to get current online players\n  const lpResult = await takaro.gameserver.gameServerControllerExecuteCommand(gameServerId, {\n    command: 'lp'\n  });\n  \n  const output = lpResult.data.data.rawResult;\n  \n  if (!output) {\n    console.log('No lp output received');\n    return;\n  }\n  \n  console.log('LP Output:', output);\n  \n  // Parse current online player data\n  const lines = output.split('\\n');\n  const onlinePlayers = [];\n  \n  for (const line of lines) {\n    const idMatch = line.match(/id=(\\d+)/);\n    const nameMatch = line.match(/id=\\d+,\\s*([^,]+),/);\n    const deathsMatch = line.match(/deaths=(\\d+)/);\n    const zombiesMatch = line.match(/zombies=(\\d+)/);\n    const playersMatch = line.match(/players=(\\d+)/);\n    const levelMatch = line.match(/level=(\\d+)/);\n    const steamIdMatch = line.match(/Steam_(\\d+)/);\n    \n    if (idMatch && nameMatch && deathsMatch && zombiesMatch && playersMatch && levelMatch && steamIdMatch) {\n      onlinePlayers.push({\n        steamId: steamIdMatch[1],\n        name: nameMatch[1].trim(),\n        deaths: parseInt(deathsMatch[1]),\n        zombies: parseInt(zombiesMatch[1]),\n        playerKills: parseInt(playersMatch[1]),\n        level: parseInt(levelMatch[1])\n      });\n    }\n  }\n  \n  console.log(`Found ${onlinePlayers.length} online players`);\n  \n  // Load stored leaderboard data\n  const variableSearch = await takaro.variable.variableControllerSearch({\n    filters: {\n      key: ['leaderboard_data'],\n      moduleId: [data.module.moduleId],\n      gameServerId: [gameServerId]\n    }\n  });\n  \n  let storedPlayers = {};\n  let leaderboardDataVarId = null;\n  \n  if (variableSearch.data.data.length > 0) {\n    leaderboardDataVarId = variableSearch.data.data[0].id;\n    try {\n      storedPlayers = JSON.parse(variableSearch.data.data[0].value);\n      console.log(`Loaded ${Object.keys(storedPlayers).length} stored players`);\n    } catch (error) {\n      console.log('Failed to parse stored data, starting fresh');\n      storedPlayers = {};\n    }\n  }\n  \n  // Update stored data with current online players\n  for (const player of onlinePlayers) {\n    const existing = storedPlayers[player.steamId];\n    \n    if (!existing) {\n      // New player\n      storedPlayers[player.steamId] = player;\n      console.log(`Added new player: ${player.name}`);\n    } else {\n      // Update if stats are higher (player progressed)\n      if (player.zombies > existing.zombies || \n          player.playerKills > existing.playerKills || \n          player.level > existing.level || \n          player.deaths > existing.deaths) {\n        storedPlayers[player.steamId] = player;\n        console.log(`Updated stats for: ${player.name}`);\n      }\n    }\n  }\n  \n  // Save updated data\n  const storedDataJson = JSON.stringify(storedPlayers);\n  \n  if (leaderboardDataVarId) {\n    await takaro.variable.variableControllerUpdate(leaderboardDataVarId, {\n      value: storedDataJson\n    });\n    console.log('Updated leaderboard data variable');\n  } else {\n    await takaro.variable.variableControllerCreate({\n      key: 'leaderboard_data',\n      value: storedDataJson,\n      moduleId: data.module.moduleId,\n      gameServerId: gameServerId\n    });\n    console.log('Created leaderboard data variable');\n  }\n  \n  // Convert stored players object to array for sorting\n  const allPlayers = Object.values(storedPlayers);\n  \n  if (allPlayers.length === 0) {\n    console.log('No player data available');\n    return;\n  }\n  \n  // Get top players from ALL stored data (not just online)\n  const topZombieKills = [...allPlayers].sort((a, b) => b.zombies - a.zombies).slice(0, 3);\n  const topPlayerKills = [...allPlayers].sort((a, b) => b.playerKills - a.playerKills).slice(0, 3);\n  const topLevel = [...allPlayers].sort((a, b) => b.level - a.level).slice(0, 3);\n  const topDeaths = [...allPlayers].sort((a, b) => b.deaths - a.deaths).slice(0, 1);\n  \n  // Medal emojis for ranks\n  const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];\n  \n  // Build Discord embed with better formatting\n  const embed = {\n    title: 'ðŸ† **SERVER LEADERBOARDS** ðŸ†',\n    color: 0xFF6B35, // Orange-red color\n    fields: [\n      {\n        name: 'ðŸ§Ÿ **ZOMBIE SLAYERS**',\n        value: topZombieKills.map((p, i) => \n          `${medals[i]} \\`${p.name}\\` â€¢ **${p.zombies.toLocaleString()}** kills`\n        ).join('\\n'),\n        inline: false\n      },\n      {\n        name: 'âš”ï¸ **PVP WARRIORS**',\n        value: topPlayerKills.map((p, i) => \n          `${medals[i]} \\`${p.name}\\` â€¢ **${p.playerKills}** kills`\n        ).join('\\n'),\n        inline: false\n      },\n      {\n        name: 'ðŸ“ˆ **HIGHEST LEVELS**',\n        value: topLevel.map((p, i) => \n          `${medals[i]} \\`${p.name}\\` â€¢ Level **${p.level}**`\n        ).join('\\n'),\n        inline: false\n      },\n      {\n        name: 'ðŸ’€ **MOST DEATHS**',\n        value: topDeaths.map((p, i) => \n          `ðŸª¦ \\`${p.name}\\` â€¢ **${p.deaths}** deaths`\n        ).join('\\n'),\n        inline: false\n      }\n    ],\n    timestamp: new Date().toISOString(),\n    footer: {\n      text: 'ðŸ“Š Updates every hour at :55'\n    }\n  };\n  \n  // Check if we have a stored message ID\n  const messageIdSearch = await takaro.variable.variableControllerSearch({\n    filters: {\n      key: ['leaderboard_message_id'],\n      moduleId: [data.module.moduleId],\n      gameServerId: [gameServerId]\n    }\n  });\n  \n  let messageId = null;\n  if (messageIdSearch.data.data.length > 0) {\n    messageId = messageIdSearch.data.data[0].value;\n    console.log('Found existing message ID:', messageId);\n  }\n  \n  if (messageId) {\n    // Update existing message\n    try {\n      await takaro.discord.discordControllerUpdateMessage(discordChannelId, messageId, {\n        embed: embed\n      });\n      console.log('Updated existing Discord message');\n    } catch (error) {\n      console.log('Failed to update message, creating new one. Error:', error);\n      // If update fails (message deleted, etc), create new message\n      const newMessage = await takaro.discord.discordControllerSendMessage(discordChannelId, {\n        embed: embed\n      });\n      \n      // Update the variable with new message ID\n      await takaro.variable.variableControllerUpdate(messageIdSearch.data.data[0].id, {\n        value: newMessage.data.data.id\n      });\n      console.log('Created new message and updated variable');\n    }\n  } else {\n    // Create new message and store the ID\n    const newMessage = await takaro.discord.discordControllerSendMessage(discordChannelId, {\n      embed: embed\n    });\n    \n    await takaro.variable.variableControllerCreate({\n      key: 'leaderboard_message_id',\n      value: newMessage.data.data.id,\n      moduleId: data.module.moduleId,\n      gameServerId: gameServerId\n    });\n    console.log('Created new message and stored ID in variable');\n  }\n  \n  // Announce in game - separate message for each category\n  const announcements = [\n    `Top Zombie Killer: ${topZombieKills[0].name} with ${topZombieKills[0].zombies} kills!`,\n    `Top Player Killer: ${topPlayerKills[0].name} with ${topPlayerKills[0].playerKills} kills!`,\n    `Highest Level: ${topLevel[0].name} at Level ${topLevel[0].level}!`,\n    `Most Deaths: ${topDeaths[0].name} with ${topDeaths[0].deaths} deaths!`\n  ];\n  \n  for (const announcement of announcements) {\n    await takaro.gameserver.gameServerControllerSendMessage(gameServerId, {\n      message: announcement\n    });\n  }\n  \n  console.log('Leaderboards updated successfully');\n}\n\nawait main();",
          "name": "Update Leaderboards",
          "description": "Runs every hour at minute 55 to collect player stats and update leaderboards",
          "temporalValue": "55 * * * *"
        }
      ],
      "functions": [],
      "permissions": []
    }
  ],
  "takaroVersion": "v0.4.10"
}
