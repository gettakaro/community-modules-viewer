{
    "name": "Discord Links",
    "author": "Mad",
    "supportedGames": [
        "all"
    ],
    "versions": [
        {
            "tag": "latest",
            "description": "Posts configurable rich text links with inline images to Discord. Updates the same message daily instead of creating new ones.",
            "configSchema": "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"discordChannelId\": {\n      \"type\": \"string\",\n      \"title\": \"Discord Channel ID\",\n      \"description\": \"The Discord channel ID where links will be posted\",\n      \"minLength\": 17,\n      \"maxLength\": 20\n    },\n    \"messageColor\": {\n      \"type\": \"number\",\n      \"title\": \"Message Color\",\n      \"description\": \"Decimal color code for the embed (0-16777215)\",\n      \"default\": 5814783,\n      \"minimum\": 0,\n      \"maximum\": 16777215\n    },\n    \"decorativeHeader\": {\n      \"type\": \"string\",\n      \"title\": \"Decorative Header\",\n      \"description\": \"Optional decorative text at the top of the message\",\n      \"default\": \"‚ú¶‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ú¶\"\n    },\n    \"links\": {\n      \"type\": \"array\",\n      \"title\": \"Links\",\n      \"description\": \"List of links to display\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"emoji\": {\n            \"type\": \"string\",\n            \"title\": \"Emoji\",\n            \"description\": \"Emoji to display before the link\",\n            \"default\": \"üîó\"\n          },\n          \"title\": {\n            \"type\": \"string\",\n            \"title\": \"Link Title\",\n            \"description\": \"Title of the link\"\n          },\n          \"url\": {\n            \"type\": \"string\",\n            \"title\": \"Link URL\",\n            \"description\": \"URL to link to\"\n          },\n          \"description\": {\n            \"type\": \"string\",\n            \"title\": \"Description\",\n            \"description\": \"Optional description text to show below the link\"\n          },\n          \"secondaryTitle\": {\n            \"type\": \"string\",\n            \"title\": \"Secondary Link Title\",\n            \"description\": \"Optional secondary link title (displayed directly under description)\"\n          },\n          \"secondaryUrl\": {\n            \"type\": \"string\",\n            \"title\": \"Secondary Link URL\",\n            \"description\": \"Optional secondary link URL\"\n          }\n        },\n        \"required\": [\"title\", \"url\"]\n      },\n      \"minItems\": 1\n    }\n  },\n  \"required\": [\"discordChannelId\", \"links\"]\n}",
            "uiSchema": "{\"discordChannelId\":{\"ui:help\":\"Right-click on a Discord channel and select 'Copy Channel ID'\"},\"messageColor\":{\"ui:help\":\"Use a decimal color code (e.g., 5814783 for blue). Convert hex to decimal online.\"},\"links\":{\"ui:options\":{\"orderable\":true},\"items\":{\"imageUrl\":{\"ui:help\":\"Must be a direct link to an image file (jpg, png, gif, etc.)\"}}}}",
            "commands": [],
            "hooks": [],
            "cronJobs": [
                {
                    "function": "import { takaro, data } from '@takaro/helpers';\n\nasync function main() {\n    console.log('[Daily Discord Links] Starting daily link post');\n    \n    // Access config from data.module.userConfig (correct for cronjobs)\n    const config = data.module.userConfig;\n    const moduleId = data.module.moduleId;\n    const gameServerId = data.gameServerId;\n    \n    // Validate configuration\n    if (!config || !config.discordChannelId) {\n        console.error('[Daily Discord Links] No Discord channel ID configured');\n        return { success: false, message: 'Discord channel ID not configured' };\n    }\n    \n    if (!config.links || config.links.length === 0) {\n        console.error('[Daily Discord Links] No links configured');\n        return { success: false, message: 'No links configured' };\n    }\n    \n    const channelId = config.discordChannelId;\n    const color = config.messageColor || 5814783;\n    const header = config.decorativeHeader || '‚ú¶‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ú¶';\n    \n    console.log(`[Daily Discord Links] Building embed for channel ${channelId}`);\n    \n    // Build description with decorative header, emojis, descriptions, secondary links, and spacing\n    let description = header + '\\n\\n';\n    \n    for (let i = 0; i < config.links.length; i++) {\n        const link = config.links[i];\n        const emoji = link.emoji || 'üîó';\n        \n        description += `# ${emoji} [${link.title}](${link.url})`;\n        \n        // Add description if provided\n        if (link.description) {\n            description += `\\n${link.description}`;\n        }\n        \n        // Add secondary link if both title and URL are provided (no extra spacing)\n        if (link.secondaryTitle && link.secondaryUrl) {\n            description += `\\n[${link.secondaryTitle}](${link.secondaryUrl})`;\n        }\n        \n        // Add spacing between links (but not after the last one)\n        if (i < config.links.length - 1) {\n            description += '\\n\\n';\n        }\n    }\n    \n    const embed = {\n        description: description.trim(),\n        color: color\n    };\n    \n    // Try to get stored message ID from module variables\n    let storedMessageId = null;\n    let storedVariableId = null;\n    \n    try {\n        const variableSearch = await takaro.variable.variableControllerSearch({\n            filters: {\n                key: ['discord_message_id'],\n                moduleId: [moduleId],\n                gameServerId: [gameServerId]\n            }\n        });\n        \n        if (variableSearch.data.data.length > 0) {\n            storedMessageId = variableSearch.data.data[0].value;\n            storedVariableId = variableSearch.data.data[0].id;\n            console.log(`[Daily Discord Links] Found stored message ID: ${storedMessageId}`);\n        }\n    } catch (error) {\n        console.log('[Daily Discord Links] No stored message ID found, will create new message');\n    }\n    \n    // Try to update existing message if we have an ID\n    if (storedMessageId) {\n        try {\n            console.log(`[Daily Discord Links] Attempting to update existing message ${storedMessageId}`);\n            await takaro.discord.discordControllerUpdateMessage(channelId, storedMessageId, {\n                embed: embed\n            });\n            console.log('[Daily Discord Links] Successfully updated existing message');\n            return { success: true, message: 'Discord message updated successfully' };\n        } catch (error) {\n            console.log(`[Daily Discord Links] Failed to update message: ${error.message}, will create new message`);\n        }\n    }\n    \n    // Create new message if update failed or no stored ID\n    try {\n        console.log('[Daily Discord Links] Creating new Discord message');\n        const response = await takaro.discord.discordControllerSendMessage(channelId, {\n            embed: embed\n        });\n        \n        const newMessageId = response.data.data.id;\n        console.log(`[Daily Discord Links] Successfully created message with ID: ${newMessageId}`);\n        \n        // Store or update the message ID variable\n        try {\n            if (storedVariableId) {\n                // Update existing variable\n                await takaro.variable.variableControllerUpdate(storedVariableId, {\n                    value: newMessageId\n                });\n                console.log('[Daily Discord Links] Updated stored message ID');\n            } else {\n                // Create new variable\n                await takaro.variable.variableControllerCreate({\n                    key: 'discord_message_id',\n                    value: newMessageId,\n                    moduleId: moduleId,\n                    gameServerId: gameServerId\n                });\n                console.log('[Daily Discord Links] Created new stored message ID');\n            }\n        } catch (error) {\n            console.error(`[Daily Discord Links] Failed to store message ID: ${error.message}`);\n        }\n        \n        return { success: true, message: 'Discord message created successfully' };\n    } catch (error) {\n        console.error(`[Daily Discord Links] Failed to create message: ${error.message}`);\n        return { success: false, message: `Failed to create Discord message: ${error.message}` };\n    }\n}\n\nawait main();",
                    "name": "Daily Link Update",
                    "description": "Updates the Discord message with daily links once per day",
                    "temporalValue": "0 12 * * *"
                }
            ],
            "functions": [
                {
                    "function": "import { takaro, data } from '@takaro/helpers';\n\nasync function main() {\n    const { pog, module: mod, gameServer } = data;\n    const config = pog.userConfig;\n    \n    console.log('[Daily Discord Links] Starting daily link post');\n    \n    // Validate configuration\n    if (!config.discordChannelId) {\n        console.error('[Daily Discord Links] No Discord channel ID configured');\n        return { success: false, message: 'Discord channel ID not configured' };\n    }\n    \n    if (!config.links || config.links.length === 0) {\n        console.error('[Daily Discord Links] No links configured');\n        return { success: false, message: 'No links configured' };\n    }\n    \n    const channelId = config.discordChannelId;\n    const title = config.messageTitle || 'Daily Links';\n    const description = config.messageDescription || 'Here are today\\'s important links';\n    const color = config.messageColor || 5814783;\n    \n    // Build the embed with links\n    const fields = [];\n    \n    for (const link of config.links) {\n        let fieldValue = link.description;\n        \n        // Add the URL as a clickable link\n        if (link.url) {\n            fieldValue += `\\n[üîó Visit](${link.url})`;\n        }\n        \n        // Add image if provided\n        if (link.imageUrl) {\n            fieldValue += `\\n[üì∑ Image](${link.imageUrl})`;\n        }\n        \n        fields.push({\n            name: link.title,\n            value: fieldValue,\n            inline: false\n        });\n    }\n    \n    const embed = {\n        title: title,\n        description: description,\n        color: color,\n        fields: fields,\n        timestamp: new Date().toISOString(),\n        footer: {\n            text: 'Updated daily'\n        }\n    };\n    \n    // Try to get stored message ID from module variables\n    let storedMessageId = null;\n    \n    try {\n        const variableSearch = await takaro.variable.variableControllerSearch({\n            filters: {\n                key: ['discord_message_id'],\n                moduleId: [data.module.moduleId],\n                gameServerId: [gameServer.id]\n            }\n        });\n        \n        if (variableSearch.data.data.length > 0) {\n            storedMessageId = variableSearch.data.data[0].value;\n            console.log(`[Daily Discord Links] Found stored message ID: ${storedMessageId}`);\n        }\n    } catch (error) {\n        console.log('[Daily Discord Links] No stored message ID found, will create new message');\n    }\n    \n    // Try to update existing message if we have an ID\n    if (storedMessageId) {\n        try {\n            console.log(`[Daily Discord Links] Attempting to update existing message ${storedMessageId}`);\n            await takaro.discord.discordControllerUpdateMessage(channelId, storedMessageId, {\n                embed: embed\n            });\n            console.log('[Daily Discord Links] Successfully updated existing message');\n            return { success: true, message: 'Discord message updated successfully' };\n        } catch (error) {\n            console.log(`[Daily Discord Links] Failed to update message: ${error.message}, will create new message`);\n        }\n    }\n    \n    // Create new message if update failed or no stored ID\n    try {\n        console.log('[Daily Discord Links] Creating new Discord message');\n        const response = await takaro.discord.discordControllerSendMessage(channelId, {\n            embed: embed\n        });\n        \n        const newMessageId = response.data.data.id;\n        console.log(`[Daily Discord Links] Successfully created message with ID: ${newMessageId}`);\n        \n        // Store the new message ID for future updates\n        try {\n            // First, try to update if variable exists\n            if (storedMessageId) {\n                const variableSearch = await takaro.variable.variableControllerSearch({\n                    filters: {\n                        key: ['discord_message_id'],\n                        moduleId: [data.module.moduleId],\n                        gameServerId: [gameServer.id]\n                    }\n                });\n                \n                if (variableSearch.data.data.length > 0) {\n                    await takaro.variable.variableControllerUpdate(variableSearch.data.data[0].id, {\n                        value: newMessageId\n                    });\n                } else {\n                    throw new Error('Variable not found');\n                }\n            } else {\n                // Create new variable\n                await takaro.variable.variableControllerCreate({\n                    key: 'discord_message_id',\n                    value: newMessageId,\n                    moduleId: data.module.moduleId,\n                    gameServerId: gameServer.id\n                });\n            }\n            console.log('[Daily Discord Links] Stored new message ID');\n        } catch (error) {\n            console.error(`[Daily Discord Links] Failed to store message ID: ${error.message}`);\n        }\n        \n        return { success: true, message: 'Discord message created successfully' };\n    } catch (error) {\n        console.error(`[Daily Discord Links] Failed to create message: ${error.message}`);\n        return { success: false, message: `Failed to create Discord message: ${error.message}` };\n    }\n}\n\nawait main();",
                    "name": "postDailyLinks",
                    "description": "Posts or updates a Discord message with configurable links and images"
                }
            ],
            "permissions": []
        }
    ],
    "takaroVersion": "v0.4.9"
}